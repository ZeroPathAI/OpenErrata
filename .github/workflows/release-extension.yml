name: Release Extension

on:
  push:
    tags:
      - "ext-v*"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: release-extension-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    outputs:
      version: ${{ steps.version.outputs.version }}
    defaults:
      run:
        working-directory: src/typescript
    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/postgres
    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup TypeScript workspace
        uses: ./.github/actions/setup-typescript-workspace
        with:
          install-playwright-chromium: "true"
          playwright-with-deps: "true"

      - name: Typecheck
        run: pnpm typecheck

      - name: Lint and static checks
        run: pnpm lint:ci

      - name: Run unit tests with coverage
        run: pnpm run test:unit:coverage

      - name: Run API integration tests
        run: pnpm run test:integration:api

      - name: Build extension
        run: pnpm --filter @openerrata/extension build

      - name: Run extension e2e tests
        run: pnpm run test:e2e:extension:ci

      - name: Determine version
        id: version
        shell: bash
        run: |
          if [[ "$GITHUB_REF_TYPE" == "tag" ]]; then
            echo "version=${GITHUB_REF_NAME#ext-v}" >> "$GITHUB_OUTPUT"
          else
            echo "version=$(date +%Y%m%d)-${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"
          fi

      - name: Package extension artifacts
        env:
          OPENERRATA_EXTENSION_PACKAGE_VERSION: ${{ steps.version.outputs.version }}
          OPENERRATA_EXTENSION_PACKAGE_OUT_DIR: ${{ github.workspace }}
          OPENERRATA_REQUIRE_CRX_SIGNING_KEY: "true"
          OPENERRATA_CHROME_CRX_PRIVATE_KEY: ${{ secrets.CHROME_CRX_PRIVATE_KEY }}
        run: pnpm --filter @openerrata/extension package:artifacts

      - name: Enforce bundle size hard limit
        shell: bash
        run: |
          set -euo pipefail

          chrome_zip="$GITHUB_WORKSPACE/openerrata-extension-chrome-${{ steps.version.outputs.version }}.zip"
          chrome_crx="$GITHUB_WORKSPACE/openerrata-extension-chrome-${{ steps.version.outputs.version }}.crx"
          firefox_zip="$GITHUB_WORKSPACE/openerrata-extension-firefox-${{ steps.version.outputs.version }}.zip"
          firefox_xpi="$GITHUB_WORKSPACE/openerrata-extension-firefox-${{ steps.version.outputs.version }}.xpi"
          limit_bytes=5242880

          for artifact in "$chrome_zip" "$chrome_crx" "$firefox_zip" "$firefox_xpi"; do
            bytes="$(stat -c%s "$artifact")"
            if [ "$bytes" -gt "$limit_bytes" ]; then
              echo "$(basename "$artifact") exceeds 5 MiB: ${bytes} bytes"
              exit 1
            fi
          done

      - name: Verify Firefox package integrity
        run: |
          unzip -t "$GITHUB_WORKSPACE/openerrata-extension-firefox-${{ steps.version.outputs.version }}.zip"
          unzip -t "$GITHUB_WORKSPACE/openerrata-extension-firefox-${{ steps.version.outputs.version }}.xpi"

      - name: Lint Firefox extension package
        run: npx -y web-ext@8.9.0 lint --source-dir extension/dist/firefox

      - name: Upload packaged extension artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openerrata-extension-packages-${{ steps.version.outputs.version }}
          path: |
            ${{ github.workspace }}/openerrata-extension-chrome-${{ steps.version.outputs.version }}.zip
            ${{ github.workspace }}/openerrata-extension-chrome-${{ steps.version.outputs.version }}.crx
            ${{ github.workspace }}/openerrata-extension-firefox-${{ steps.version.outputs.version }}.zip
            ${{ github.workspace }}/openerrata-extension-firefox-${{ steps.version.outputs.version }}.xpi

  release:
    needs: [build-and-test]
    if: github.ref_type == 'tag'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
    steps:
      - name: Download packaged extension artifacts
        uses: actions/download-artifact@v4
        with:
          name: openerrata-extension-packages-${{ needs.build-and-test.outputs.version }}
          path: .

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            openerrata-extension-chrome-${{ needs.build-and-test.outputs.version }}.zip
            openerrata-extension-chrome-${{ needs.build-and-test.outputs.version }}.crx
            openerrata-extension-firefox-${{ needs.build-and-test.outputs.version }}.zip
            openerrata-extension-firefox-${{ needs.build-and-test.outputs.version }}.xpi
          generate_release_notes: true

  publish:
    needs: [build-and-test, release]
    if: github.ref_type == 'tag'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment: extension-store-publish
    steps:
      - name: Download packaged extension artifacts
        uses: actions/download-artifact@v4
        with:
          name: openerrata-extension-packages-${{ needs.build-and-test.outputs.version }}
          path: .

      - name: Publish to Chrome Web Store
        if: >-
          env.CHROME_EXTENSION_ID != '' &&
          env.CHROME_CLIENT_ID != '' &&
          env.CHROME_CLIENT_SECRET != '' &&
          env.CHROME_REFRESH_TOKEN != ''
        env:
          CHROME_EXTENSION_ID: ${{ secrets.CHROME_EXTENSION_ID }}
          CHROME_CLIENT_ID: ${{ secrets.CHROME_CLIENT_ID }}
          CHROME_CLIENT_SECRET: ${{ secrets.CHROME_CLIENT_SECRET }}
          CHROME_REFRESH_TOKEN: ${{ secrets.CHROME_REFRESH_TOKEN }}
        run: |
          npx -y chrome-webstore-upload-cli@3 upload \
            --source "openerrata-extension-chrome-${{ needs.build-and-test.outputs.version }}.zip" \
            --extension-id "$CHROME_EXTENSION_ID" \
            --client-id "$CHROME_CLIENT_ID" \
            --client-secret "$CHROME_CLIENT_SECRET" \
            --refresh-token "$CHROME_REFRESH_TOKEN" \
            --auto-publish

      - name: Publish to Firefox Add-ons
        if: >-
          env.FIREFOX_JWT_ISSUER != '' &&
          env.FIREFOX_JWT_SECRET != ''
        env:
          FIREFOX_JWT_ISSUER: ${{ secrets.FIREFOX_JWT_ISSUER }}
          FIREFOX_JWT_SECRET: ${{ secrets.FIREFOX_JWT_SECRET }}
        run: |
          mkdir -p firefox-upload
          unzip -q "openerrata-extension-firefox-${{ needs.build-and-test.outputs.version }}.zip" -d firefox-upload
          npx -y web-ext@8.9.0 sign \
            --source-dir firefox-upload \
            --api-key "$FIREFOX_JWT_ISSUER" \
            --api-secret "$FIREFOX_JWT_SECRET" \
            --channel listed
