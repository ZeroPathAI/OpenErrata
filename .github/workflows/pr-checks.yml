name: PR Checks

on:
  pull_request:
    branches:
      - staging
      - main

permissions:
  contents: read

concurrency:
  group: pr-checks-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  should-run:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      skip_all: ${{ steps.gate.outputs.skip_all }}
      has_relevant_changes: ${{ steps.changes.outputs.relevant }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect relevant file changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            relevant:
              - 'src/typescript/**'
              - 'src/helm/openerrata/**'
              - '.github/workflows/**'

      - name: Check for promote PR
        id: gate
        shell: bash
        env:
          HEAD_REF: ${{ github.head_ref }}
          HEAD_REPO: ${{ github.event.pull_request.head.repo.full_name }}
          BASE_REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          if [ "$HEAD_REPO" = "$BASE_REPO" ] && { [ "$HEAD_REF" = "staging" ] || [ "$HEAD_REF" = "main" ]; }; then
            echo "skip_all=true" >> "$GITHUB_OUTPUT"
            echo "Skipping PR checks for promote branch: $HEAD_REF"
          else
            echo "skip_all=false" >> "$GITHUB_OUTPUT"
          fi

  helm-lint:
    needs: [should-run]
    if: >-
      needs.should-run.outputs.skip_all != 'true' &&
      needs.should-run.outputs.has_relevant_changes == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4

      - name: Lint chart
        shell: bash
        run: |
          set -euo pipefail
          helm lint src/helm/openerrata -f src/helm/openerrata/ci-values.yaml
          helm template openerrata src/helm/openerrata -f src/helm/openerrata/ci-values.yaml > /dev/null

  typecheck:
    needs: [should-run]
    if: >-
      needs.should-run.outputs.skip_all != 'true' &&
      needs.should-run.outputs.has_relevant_changes == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    defaults:
      run:
        working-directory: src/typescript
    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/postgres
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup TypeScript workspace
        uses: ./.github/actions/setup-typescript-workspace

      - name: Typecheck
        run: pnpm typecheck

  lint:
    needs: [should-run]
    if: >-
      needs.should-run.outputs.skip_all != 'true' &&
      needs.should-run.outputs.has_relevant_changes == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    defaults:
      run:
        working-directory: src/typescript
    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/postgres
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup TypeScript workspace
        uses: ./.github/actions/setup-typescript-workspace

      - name: Lint and static checks
        run: pnpm lint:ci

  test:
    needs: [should-run]
    if: >-
      needs.should-run.outputs.skip_all != 'true' &&
      needs.should-run.outputs.has_relevant_changes == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    defaults:
      run:
        working-directory: src/typescript
    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/postgres
    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup TypeScript workspace
        uses: ./.github/actions/setup-typescript-workspace

      - name: Run unit tests with coverage
        run: pnpm run test:unit:coverage

      - name: Run API integration tests
        run: pnpm run test:integration:api

  build:
    needs: [should-run]
    if: >-
      needs.should-run.outputs.skip_all != 'true' &&
      needs.should-run.outputs.has_relevant_changes == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    defaults:
      run:
        working-directory: src/typescript
    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/postgres
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup TypeScript workspace
        uses: ./.github/actions/setup-typescript-workspace

      - name: Build workspace
        run: pnpm build

      - name: Archive extension dist artifact
        shell: bash
        run: tar -C extension -czf "$RUNNER_TEMP/extension-dist.tgz" dist

      - name: Upload extension dist artifact
        uses: actions/upload-artifact@v4
        with:
          name: extension-dist-${{ github.sha }}
          path: ${{ runner.temp }}/extension-dist.tgz
          retention-days: 1

      - name: Summarize extension bundle sizes
        shell: bash
        run: |
          set -euo pipefail

          chrome_dir="extension/dist"
          firefox_dir="extension/dist/firefox"

          chrome_bytes="$(du -sb "$chrome_dir" | awk '{print $1}')"
          firefox_bytes="$(du -sb "$firefox_dir" | awk '{print $1}')"

          {
            echo "### Extension Bundle Size Report"
            echo
            echo "| Artifact | Bytes | MiB |"
            echo "|---|---:|---:|"
            echo "| Chrome dist dir | ${chrome_bytes} | $(awk "BEGIN {printf \"%.2f\", ${chrome_bytes}/1048576}") |"
            echo "| Firefox dist dir | ${firefox_bytes} | $(awk "BEGIN {printf \"%.2f\", ${firefox_bytes}/1048576}") |"
            echo
            echo "#### Largest JS files (top 10)"
            echo
            echo "| File | Bytes | KiB |"
            echo "|---|---:|---:|"
          } >> "$GITHUB_STEP_SUMMARY"

          find "$chrome_dir" -type f -name "*.js" -printf '%s\t%p\n' \
            | sort -nr \
            | head -n 10 \
            | while IFS=$'\t' read -r size path; do
                echo "| ${path} | ${size} | $(awk "BEGIN {printf \"%.2f\", ${size}/1024}") |" >> "$GITHUB_STEP_SUMMARY"
              done

  e2e:
    needs: [should-run, build]
    if: >-
      needs.should-run.outputs.skip_all != 'true' &&
      needs.should-run.outputs.has_relevant_changes == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 25
    defaults:
      run:
        working-directory: src/typescript
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup TypeScript workspace
        uses: ./.github/actions/setup-typescript-workspace
        with:
          generate-prisma: "false"
          install-playwright-chromium: "true"

      - name: Download extension dist artifact
        uses: actions/download-artifact@v4
        with:
          name: extension-dist-${{ github.sha }}
          path: ${{ runner.temp }}

      - name: Restore extension dist artifact
        shell: bash
        run: tar -C extension -xzf "$RUNNER_TEMP/extension-dist.tgz"

      - name: Run extension e2e tests
        run: pnpm run test:e2e:extension:ci

  no-relevant-changes:
    needs: [should-run]
    if: >-
      needs.should-run.outputs.skip_all != 'true' &&
      needs.should-run.outputs.has_relevant_changes != 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Skip informational step
        run: echo "No relevant files changed; skipping TypeScript checks."

  pr-ok:
    needs: [should-run, helm-lint, typecheck, lint, test, build, e2e, no-relevant-changes]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Final PR gate
        shell: bash
        run: |
          set -euo pipefail

          if [ "${{ needs.should-run.outputs.skip_all }}" = "true" ]; then
            echo "Promote PR; deploy workflow is the source of truth."
            exit 0
          fi

          HELM_LINT="${{ needs.helm-lint.result }}"
          TYPECHECK="${{ needs.typecheck.result }}"
          LINT="${{ needs.lint.result }}"
          TEST="${{ needs.test.result }}"
          BUILD="${{ needs.build.result }}"
          E2E="${{ needs.e2e.result }}"

          if [ "$HELM_LINT" = "success" ] && [ "$TYPECHECK" = "success" ] && [ "$LINT" = "success" ] && \
             [ "$TEST" = "success" ] && [ "$BUILD" = "success" ] && [ "$E2E" = "success" ]; then
            echo "All quality gate jobs passed."
            exit 0
          fi

          if [ "${{ needs.no-relevant-changes.result }}" = "success" ]; then
            echo "No relevant changes; PR gate passes."
            exit 0
          fi

          echo "PR checks did not pass."
          echo "  helm-lint: $HELM_LINT"
          echo "  typecheck: $TYPECHECK"
          echo "  lint: $LINT"
          echo "  test: $TEST"
          echo "  build: $BUILD"
          echo "  e2e: $E2E"
          exit 1
